# comprobe

A tool to probe dlls for their COM registry.

## Overview

Use this tool to avoid calling `regsvr32.exe`, `regtlib.exe` and `regasm.exe`. These three tools are meant to be run at installation time, whereas `comprobe.exe` is meant to be used at build time, because it saves the result to an xml file instead of the actual Windows Registry. This xml file can be later imported to the Windows Registry (at installation time) by using [xmlreg.exe](https://github.com/alexsandrovp/xmlreg)

The reason to use `comprobe.exe` and `xmlreg.exe` to install COM registry is because when you run `regsvr32.exe`, `regtlib.exe` and `regasm.exe`, all the dependencies that the COM host dll needs to run must be installed. At installation time, this usually is not a problem, but it can cause problems during <ins>uninstallation</ins>.

DLLs hosting COM types usually have dependencies on Microsoft's Visual Studio C++ Runtime Redistributables (the ubiquitous `vcredist`). When a user decides he doesn't want to use your software anymore, he might decide to uninstall `vcredist` before running your uninstaller. In that case, if your uninstaller uses `regsvr32.exe`, `regtlib.exe` or `regasm.exe` to remove the COM registry, the uninstallation will fail, and your software cannot be removed until the user reinstalls `vcredist`. This situation is understandably annoying to anyone, and your work will be seen by most people as unprofessional.

When running `comprobe.exe`, you will not fall in the situation where the DLL dependencies are not present, because you are running it in your build machine. In the final user machine, you only run `xmlreg.exe` (which has no dependencies of its own) using the xml file generated by `comprobe.exe`.

This tool was inspired in the [wix toolset](wixtoolset.org) harvester tool (`heat.exe`), but no code was copied from there.

<br>

How to use:

```
comprobe.exe <host.dll> <output.xml> [--dll-bitness <bitness>] [--unattended]  
        [--type-library] [--hkcr2hklm] [--hkcr2hkcu] [--keep-com-paths]
```

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`-y`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`--unattended`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Assume yes on all queries.

<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`-tlb`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`--type-library`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Uses [RegisterTypeLib](https://docs.microsoft.com/en-us/windows/win32/api/oleauto/nf-oleauto-registertypelib) instead of [DllRegisterServer](https://docs.microsoft.com/en-us/windows/win32/api/olectl/nf-olectl-dllregisterserver).

<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`-hklm`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`--hkcr2hklm`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Outputs to __HKLM\Software\Classes__ instead of __HKCR__.

<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`-hkcu`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`--hkcr2hkcu`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Outputs to __HKCU\Software\Classes__ instead of __HKCR__.

<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`-kcp`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`--keep-com-paths`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;When the COM registry entries are created, some of them reference the path to the host dll in your build machine, but that is hardly the path that is going to be used in the user's machine. Because of that, `comprobe.exe` replaces these paths with variables that can be recognized by `xmlreg.exe`. In case you don't want these variables to be created and you want to keep the original paths, use this option.

<br>

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`-bits`  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;`--dll-bitness` < bitness >  
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Forces the output xml to contain a `redirection` attribute.

<br>

## Examples

```
comprobe.exe host.dll host.xml
```

Generates this xml
```xml
<fragment hive="HKCR">
    ... (COM types) ...
</fragment>
```

<br>

_____________________________

<br>


```
comprobe.exe host.dll host.xml -bits 32
```

Generates this xml
```xml
<fragment hive="HKCR" redirection="32">
    ... (COM types) ...
</fragment>
```

<br>

_____________________________

<br>

```
comprobe.exe host.dll host.xml -bits 64 -hkcu
```

Generates this xml
```xml
<fragment hive="HKCU" key="Software\Classes" redirection="64">
    ... (COM types) ...
</fragment>
```
<br>

_____________________________

<br>

At install time, use [xmlreg.exe](https://github.com/alexsandrovp/xmlreg)

```
xmlreg.exe --import host.xml --com-dll "c:\installdir\host.dll"
```

_____________________________

<br>

At uninstall time, use [xmlreg.exe](https://github.com/alexsandrovp/xmlreg) in wipe mode

```
xmlreg.exe --wipe host.xml
```

<br>
<br>
<br>

## Acknowledgments

<br>

### https://pugixml.org/
_____________________________

 pugixml parser - version 1.10
 --------------------------------------------------------
 Copyright (C) 2006-2019, by Arseny Kapoulkine (arseny.kapoulkine@gmail.com)
 Report bugs and download new versions at https://pugixml.org/
 
 This library is distributed under the MIT License. See notice at the end
 of this file.
 
 This work is based on the pugxml parser, which is:
 Copyright (C) 2003, by Kristen Wegner (kristen@tima.net)
 

Copyright (c) 2006-2019 Arseny Kapoulkine

<br>


Permission is hereby granted, free of charge, to any person
obtaining a copy of this software and associated documentation
files (the "Software"), to deal in the Software without
restriction, including without limitation the rights to use,
copy, modify, merge, publish, distribute, sublicense, and/or sell
copies of the Software, and to permit persons to whom the
Software is furnished to do so, subject to the following
conditions:

The above copyright notice and this permission notice shall be
included in all copies or substantial portions of the Software.

THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES
OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT
HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY,
WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR
 OTHER DEALINGS IN THE SOFTWARE.

 _____________________________
